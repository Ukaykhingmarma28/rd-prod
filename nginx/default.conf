# ── FastCGI Cache bypass conditions ──────────────────────────────
map $http_cookie $skip_cache_cookie {
    default 0;
    "~wordpress_logged_in"       1;
    "~woocommerce_items_in_cart" 1;
    "~woocommerce_session"       1;
    "~wp_woocommerce_session"    1;
}

map $request_method $skip_cache_method {
    default 0;
    POST    1;
}

map $request_uri $skip_cache_uri {
    default 0;
    "~^/wp-admin"       1;
    "~^/wp-login\.php"  1;
    "~^/cart"           1;
    "~^/checkout"       1;
    "~^/my-account"     1;
    "~\?add-to-cart="   1;
    "~\?wc-ajax="       1;
    "~^/feed"           1;
}

# ── Detect HTTPS from Cloudflare CF-Visitor header ───────────────
# Cloudflare sends: CF-Visitor: {"scheme":"https"}
# We pass HTTPS=on to PHP so WordPress knows it's secure
map $http_cf_visitor $cf_https {
    default    "";
    '~*https'  "on";
}

server {
    listen 80;
    server_name _;

    root /var/www/html;
    index index.php index.html;

    client_max_body_size 128M;

    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Cache-Status $upstream_cache_status always;

    location ~* /\.(ht|git|env) { deny all; }
    location = /xmlrpc.php       { deny all; }

    location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff2?|ttf|svg|webp|avif)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        log_not_found off;
        try_files $uri =404;
    }

    # ── wp-admin — dedicated block, hard cache bypass ─────────────
    location ^~ /wp-admin/ {
        try_files $uri $uri/ /wp-admin/index.php?$args;

        location ~ \.php$ {
            fastcgi_pass wordpress:9000;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param HTTPS $cf_https;
            include fastcgi_params;

            fastcgi_buffers      16 16k;
            fastcgi_buffer_size  32k;
            fastcgi_read_timeout 300;

            fastcgi_cache_bypass 1;
            fastcgi_no_cache     1;
        }
    }

    # ── wp-login.php — hard cache bypass ─────────────────────────
    location = /wp-login.php {
        fastcgi_pass wordpress:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param HTTPS $cf_https;
        include fastcgi_params;

        fastcgi_buffers      16 16k;
        fastcgi_buffer_size  32k;
        fastcgi_read_timeout 300;

        fastcgi_cache_bypass 1;
        fastcgi_no_cache     1;
    }

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    # ── PHP-FPM + FastCGI Cache ───────────────────────────────────
    location ~ \.php$ {
        fastcgi_pass wordpress:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param HTTPS $cf_https;
        include fastcgi_params;

        fastcgi_buffers          16 16k;
        fastcgi_buffer_size      32k;
        fastcgi_read_timeout     300;

        fastcgi_cache            WORDPRESS;
        fastcgi_cache_valid      200 301 302 60m;
        fastcgi_cache_valid      404 1m;
        fastcgi_cache_min_uses   1;
        fastcgi_cache_use_stale  error timeout updating http_500 http_503;
        fastcgi_cache_lock       on;
        fastcgi_cache_background_update on;

        fastcgi_cache_bypass $skip_cache_cookie $skip_cache_method $skip_cache_uri;
        fastcgi_no_cache     $skip_cache_cookie $skip_cache_method $skip_cache_uri;
    }
}